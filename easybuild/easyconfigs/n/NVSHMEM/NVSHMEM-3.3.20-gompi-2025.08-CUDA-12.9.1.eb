easyblock = 'CMakeMake'

name = 'NVSHMEM'
version = '3.3.20'
versionsuffix = '-CUDA-%(cudaver)s'

homepage = 'https://developer.nvidia.com/nvshmem'
description = """NVSHMEM is a parallel programming interface based on OpenSHMEM that provides 
efficient and scalable communication for NVIDIA GPU clusters. NVSHMEM creates a 
global address space for data that spans the memory of multiple GPUs and can be 
accessed with fine-grained GPU-initiated operations, CPU-initiated operations, 
and operations on CUDA streams.
"""

toolchain = {'name': 'gompi', 'version': '2025.08'}

download_instructions = """The sources of NVSHMEM can be downloaded at NVIDIA's webpage when you have signed up for
their (free) developer program:
https://developer.nvidia.com/nvshmem-downloads"""

sources = [{
    'filename': '%(namelower)s_src_cuda-12-all-all-%(version)s.tar.gz',
    'extract_cmd': 'tar xf %s',
}]
checksums = ['96ec9620e82ec90de92c7d61a7ba03c0eba05075bf10e1fc4a066d45e7f7d21f']

builddependencies = [
    ('Autotools', '20250527'),
    ('pkgconf', '2.4.3'),
    ('CMake', '4.0.3'),
]

dependencies = [
    ('CUDA', '12.9.1', '', SYSTEM),
    ('NCCL', '2.27.7', versionsuffix),
    ('UCX-CUDA', '1.19.0', versionsuffix),
]

configopts = '-DNVSHMEM_USE_GDRCOPY=1 '
configopts += '-DGDRCOPY_HOME=${EBROOTGDRCOPY} '
configopts += '-DMPI_HOME=${EBROOTOPENMPI} '
configopts += '-DNVSHMEM_MPI_SUPPORT=1 '
configopts += '-DNVSHMEMTEST_USE_MPI_LAUNCHER=1 '
configopts += '-DNCCL_HOME=${EBROOTNCCL} '
configopts += '-DNVSHMEM_USE_NCCL=1 '
# configopts += '-DNVSHMEM_IBGDA_SUPPORT=1 '
configopts += '-DNVSHMEM_BUILDDIR=%(builddir)s '
configopts += '-DNVSHMEM_EXAMPLES_BUILDDIR=${NVSHMEM_BUILDDIR}/examples/obj '
configopts += '-DNVSHMEM_OTHERTEST_BUILDDIR=${NVSHMEM_BUILDDIR}/othertest/obj '
configopts += '-DNVSHMEM_TEST_BUILDDIR=${NVSHMEM_BUILDDIR}/test/obj '
configopts += '-DNVSHMEM_PERFTEST_BUILDDIR=${NVSHMEM_BUILDDIR}/perftest/obj '
configopts += '-DNVSHMEM_PREFIX=%(installdir)s '
configopts += '-DNVSHMEM_EXAMPLES_INSTALL=${NVSHMEM_PREFIX}/examples '
configopts += '-DNVSHMEM_OTHERTEST_INSTALL=${NVSHMEM_PREFIX}/othertest '
configopts += '-DNVSHMEM_PERFTEST_INSTALL=${NVSHMEM_PREFIX}/perftest '
configopts += '-DNVSHMEM_TEST_INSTALL=${NVSHMEM_PREFIX}/test '

# build_type = None

sanity_check_paths = {
    'files': ['lib/libnvshmem.a', 'lib/nvshmem_bootstrap_mpi.%s' % SHLIB_EXT],
    'dirs': ['include']
}

modextravars = {'NVSHMEM_HOME': '%(installdir)s'}

moduleclass = 'devel'
