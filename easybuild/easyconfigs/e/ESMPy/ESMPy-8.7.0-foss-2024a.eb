easyblock = 'PythonBundle'

name = 'ESMPy'
version = '8.7.0'

homepage = 'https://earthsystemmodeling.org/esmpy'
description = "Earth System Modeling Framework (ESMF) Python Interface"

toolchain = {'name': 'foss', 'version': '2024a'}

builddependencies = [
    ('pytest', '8.3.3'),
]

dependencies = [
    ('Python', '3.12.3'),
    ('SciPy-bundle', '2024.05'),
    ('ESMF', version),
]

# downloads of data files from data.earthsystemmodeling.org are failing at the
# time of writting, switch to github.com:
_switch_data_url_regex = r"s/^\(DATA_URL.*earthsystemmodeling.org\)/# \1/;s/# \(DATA_URL.*github.com\)/\1/"

_pre_test_cmds = [
    "sed -i '%s' src/esmpy/util/cache_data.py" % _switch_data_url_regex,
    "unset ESMPY_DATA_DIR",
    "export ESMPY_DATA_NEW_DIR=/tmp",
    "",
]

exts_list = [
    ('esmpy', version, {
        'patches': [
            'ESMPy-%(version)s_use-static-version.patch',
            'ESMPy-%(version)s_getitem.patch',
        ],
        'preinstallopts': "sed -i 's/EB_ESMPY_VERSION/%(version)s/' pyproject.toml && ",
        'pretestopts': "sed -i 's/^\(DATA_URL.*earthsystemmodeling.org\)/# ,/;s/# \(DATA_URL.*github.com\)/,/' src/esmpy/util/cache_data.py && unset ESMPY_DATA_DIR && export ESMPY_DATA_NEW_DIR=/tmp && ",
        'runtest': 'pytest',
        'source_urls': ['https://github.com/esmf-org/esmf/archive/'],
        'sources': ['v%(version)s.tar.gz'],
        'start_dir': 'src/addon/%(name)s',
        'testinstall': True,
        'checksums': [
            {'v8.7.0.tar.gz': 'd7ab266e2af8c8b230721d4df59e61aa03c612a95cc39c07a2d5695746f21f56'},
            {'ESMPy-8.7.0_use-static-version.patch':
             '84d7a9bdc5ff546303ab66b6b94222b1caddd64c6325a2c4773d991b589f6672'},
            {'ESMPy-8.7.0_getitem.patch': '2a12fb4cee249efcac94221b672743db3f70353316f4281abcd4dda46c24d261'},
        ],
    }),
]

# set data directory to a user-writable directory
# default: %(installdir)s/lib/python%(pyshortver)s/site-packages/esmpy/data
modextravars = {'ESMPY_DATA_DIR': '/tmp'}

moduleclass = 'geo'
